name: TaskSync work flow

on: # When this workflow should run
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

permissions: # Grant proper permissions
    checks: write
    contents: read

jobs: # Define the jobs (units of work) to run in parallel or series
    test-backend:
        name: âœ… Run Backend Tests
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v3

            - name: ğŸ§° Setup .NET 8
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: 8.0.x

            - name: ğŸ”§ Restore backend test dependencies
              run: dotnet restore ./backendtest

            - name: âœ… Run tests & generate report
              run: dotnet test ./backendtest --logger "trx;LogFileName=tests.trx" --results-directory ./TestResults

            - name: ğŸ“¤ Upload Test Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: backend-test-results
                  path: ./TestResults

            - name: ğŸ“ˆ Publish Test Report to GitHub UI
              if: always()
              uses: dorny/test-reporter@v1
              with:
                  name: ğŸ“‹ xUnit Test Report
                  path: ./TestResults/**/*.trx
                  reporter: dotnet-trx

    build-backend:
        name: ğŸ§ª Build Backend
        runs-on: ubuntu-latest
        needs: test-backend
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v3

            - name: ğŸ§° Setup .NET 8
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: 8.0.x

            - name: ğŸ”§ Restore backend dependencies
              run: dotnet restore ./backend

            - name: ğŸ›  Build backend
              run: dotnet build ./backend --configuration Release

    test-frontend:
        name: âœ… Run Frontend Tests
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v3

            - name: ğŸ§° Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 22.14.0

            - name: ğŸ“¦ Install dependencies
              run: npm ci
              working-directory: ./frontend

            - name: âœ… Run unit tests
              run: npm run test
              working-directory: ./frontend

            - name: ğŸ“¤ Upload Jest Test Results
              if: always() # Run even if tests fail
              uses: actions/upload-artifact@v4
              with:
                  name: jest-results
                  path: frontend/test-results/jest/results.xml

            - name: ğŸ“ˆ Publish Test Results to GitHub UI
              if: always()
              uses: dorny/test-reporter@v1
              with:
                  name: ğŸ“‹ Jest Test Report
                  path: frontend/test-results/jest/results.xml
                  reporter: jest-junit

    build-frontend:
        name: ğŸ§ª Build Frontend
        runs-on: ubuntu-latest
        needs: test-frontend
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v3

            - name: ğŸ§° Setup Node.js # Install Node.js 22.1.4
              uses: actions/setup-node@v3
              with:
                  node-version: 22.14.0

            - name: ğŸ“¦ Install dependencies
              run: npm ci # (ci = clean install)
              working-directory: ./frontend # Set working dir to your frontend folder

            - name: ğŸ›  Build frontend
              run: npm run build
              working-directory: ./frontend

    docker-push:
        name: ğŸ³ Docker Build & Push
        runs-on: ubuntu-latest
        needs: [build-backend, build-frontend] # Wait for both to pass
        if: github.event_name == 'push' # Only pushing event
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v3

            - name: ğŸ” Docker login to Docker Hub
              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            - name: ğŸ³ Build and tag backend image
              run: |
                  docker build -t ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:latest ./backend
                  docker tag ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:latest ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:${{ github.sha }}
                  docker tag ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:latest ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:${{ github.ref_name }}

            - name: ğŸš€ Push backend image
              run: |
                  docker push ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:latest
                  docker push ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:${{ github.sha }}
                  docker push ${{ secrets.DOCKER_USERNAME }}/tasksync-backend:${{ github.ref_name }}

            - name: ğŸ³ Build and tag frontend image
              run: |
                  docker build -t ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:latest ./frontend
                  docker tag ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:latest ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:${{ github.sha }}
                  docker tag ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:latest ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:${{ github.ref_name }}

            - name: ğŸš€ Push frontend image
              run: |
                  docker push ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:latest
                  docker push ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:${{ github.sha }}
                  docker push ${{ secrets.DOCKER_USERNAME }}/tasksync-frontend:${{ github.ref_name }}
